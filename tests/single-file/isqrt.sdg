// TODO: I want it to be in std when it's stable.

fn isqrt(n: Int) -> Int = match n {
    ..0 => std.panic(),
    ..9 => isqrt_dumb(n),
    _ => isqrt_iter(n, isqrt_dumb(n)),
};

fn isqrt_dumb(n: Int) -> Int = match n {
    ..0 => std.panic(),
    0 | 1 => n,
    _ => {
        let nl = n.ilog2();
        let ss = 1 << (nl >> 1);

        if nl & 1 == 1 {
            // 362 = isqrt(0x20000)
            (ss * 362) >> 8
        } else {
            ss
        }
    },
};

fn isqrt_iter(n: Int, s: Int) -> Int = {
    let ss = s * s;

    if n >= ss {
        let d = n - ss;
        let r = 2 * s + 1;

        if d < r {
            s
        }

        else {
            isqrt_iter(n, s + d / r)
        }
    }

    else {
        let d = ss - n;
        let r = 2 * s - 1;

        if d <= r {
            s - 1
        }

        else {
            isqrt_iter(n, s - d / r)
        }
    }
};

fn assert_isqrt(n: Int) = {
    let s = isqrt(n);

    if s * s <= n && n < (s + 1) * (s + 1) {
        True
    } else {
        std.panic(f"n: {n}, isqrt(n): {s}")
    }
};

fn assert_isqrt_multi(ns: [Int]) = match ns {
    [] => True,
    [$n] ++ $ns => {
        #[always]
        assert assert_isqrt(n);
        assert_isqrt_multi(ns)
    },
};

#[name("isqrt power of 1000s")]
assert assert_isqrt_multi([
    1_000,
    1_000_000,
    1_000_000_000,
    1_000_000_000_000,
    1_000_000_000_000_000,
    1_000_000_000_000_000_000,
    1_000_000_000_000_000_000_000,
    1_000_000_000_000_000_000_000_000,
    1_000_000_000_000_000_000_000_000_000,
    1_000_000_000_000_000_000_000_000_000_000,
    1_000_000_000_000_000_000_000_000_000_000_000,
    1_000_000_000_000_000_000_000_000_000_000_000_000,
    1_000_000_000_000_000_000_000_000_000_000_000_000_000,
]);

#[name("isqrt small numbers")]
assert assert_isqrt_multi([
    0, 1, 2, 3, 4,
    5, 6, 7, 8, 9,
    10, 11, 12, 13, 14,
    15, 16, 17, 18, 19,
    20, 21, 22, 23, 24,
    25, 26, 27, 28, 29,
]);

#[name("isqrt pp2")]
assert assert_isqrt_multi([
    198, 199, 200, 201, 202,
    298, 299, 300, 301, 302,
    398, 399, 400, 401, 402,
    498, 499, 500, 501, 502,
    598, 599, 600, 601, 602,
    698, 699, 700, 701, 702,
    798, 799, 800, 801, 802,
    898, 899, 900, 901, 902,
]);

#[name("isqrt pp3")]
assert assert_isqrt_multi([
    1998, 1999, 2000, 2001, 2002,
    2998, 2999, 3000, 3001, 3002,
    3998, 3999, 4000, 4001, 4002,
    4998, 4999, 5000, 5001, 5002,
    5998, 5999, 6000, 6001, 6002,
    6998, 6999, 7000, 7001, 7002,
    7998, 7999, 8000, 8001, 8002,
    8998, 8999, 9000, 9001, 9002,
]);

#[name("isqrt pp4")]
assert assert_isqrt_multi([
    19998, 19999, 20000, 20001, 20002,
    29998, 29999, 30000, 30001, 30002,
    39998, 39999, 40000, 40001, 40002,
    49998, 49999, 50000, 50001, 50002,
    59998, 59999, 60000, 60001, 60002,
    69998, 69999, 70000, 70001, 70002,
    79998, 79999, 80000, 80001, 80002,
    89998, 89999, 90000, 90001, 90002,
]);

#[name("isqrt power of 2s")]
assert assert_isqrt_multi([
    (1 << 32) - 2, (1 << 32) - 1, 1 << 32, (1 << 32) + 1, (1 << 32) + 2,
    (1 << 33) - 2, (1 << 33) - 1, 1 << 33, (1 << 33) + 1, (1 << 33) + 2,
    (1 << 34) - 2, (1 << 34) - 1, 1 << 34, (1 << 34) + 1, (1 << 34) + 2,
    (1 << 35) - 2, (1 << 35) - 1, 1 << 35, (1 << 35) + 1, (1 << 35) + 2,
    (1 << 36) - 2, (1 << 36) - 1, 1 << 36, (1 << 36) + 1, (1 << 36) + 2,
    (1 << 37) - 2, (1 << 37) - 1, 1 << 37, (1 << 37) + 1, (1 << 37) + 2,
    (1 << 38) - 2, (1 << 38) - 1, 1 << 38, (1 << 38) + 1, (1 << 38) + 2,
    (1 << 39) - 2, (1 << 39) - 1, 1 << 39, (1 << 39) + 1, (1 << 39) + 2,
]);

#[name("isqrt pp7")]
assert assert_isqrt_multi([
    19_999_998, 19_999_999, 20_000_000, 20_000_001, 20_000_002,
    29_999_998, 29_999_999, 30_000_000, 30_000_001, 30_000_002,
    39_999_998, 39_999_999, 40_000_000, 40_000_001, 40_000_002,
    49_999_998, 49_999_999, 50_000_000, 50_000_001, 50_000_002,
    59_999_998, 59_999_999, 60_000_000, 60_000_001, 60_000_002,
    69_999_998, 69_999_999, 70_000_000, 70_000_001, 70_000_002,
    79_999_998, 79_999_999, 80_000_000, 80_000_001, 80_000_002,
    89_999_998, 89_999_999, 90_000_000, 90_000_001, 90_000_002,
]);

#[name("isqrt pp8")]
assert assert_isqrt_multi([
    199_999_998, 199_999_999, 200_000_000, 200_000_001, 200_000_002,
    299_999_998, 299_999_999, 300_000_000, 300_000_001, 300_000_002,
    399_999_998, 399_999_999, 400_000_000, 400_000_001, 400_000_002,
    499_999_998, 499_999_999, 500_000_000, 500_000_001, 500_000_002,
    599_999_998, 599_999_999, 600_000_000, 600_000_001, 600_000_002,
    699_999_998, 699_999_999, 700_000_000, 700_000_001, 700_000_002,
    799_999_998, 799_999_999, 800_000_000, 800_000_001, 800_000_002,
    899_999_998, 899_999_999, 900_000_000, 900_000_001, 900_000_002,
]);

#[name("isqrt pp9")]
assert assert_isqrt_multi([
    1_999_999_998, 1_999_999_999, 2_000_000_000, 2_000_000_001, 2_000_000_002,
    2_999_999_998, 2_999_999_999, 3_000_000_000, 3_000_000_001, 3_000_000_002,
    3_999_999_998, 3_999_999_999, 4_000_000_000, 4_000_000_001, 4_000_000_002,
    4_999_999_998, 4_999_999_999, 5_000_000_000, 5_000_000_001, 5_000_000_002,
    5_999_999_998, 5_999_999_999, 6_000_000_000, 6_000_000_001, 6_000_000_002,
    6_999_999_998, 6_999_999_999, 7_000_000_000, 7_000_000_001, 7_000_000_002,
    7_999_999_998, 7_999_999_999, 8_000_000_000, 8_000_000_001, 8_000_000_002,
    8_999_999_998, 8_999_999_999, 9_000_000_000, 9_000_000_001, 9_000_000_002,
]);

#[name("isqrt pp10")]
assert assert_isqrt_multi([
    19_999_999_998, 19_999_999_999, 20_000_000_000, 20_000_000_001, 20_000_000_002,
    29_999_999_998, 29_999_999_999, 30_000_000_000, 30_000_000_001, 30_000_000_002,
    39_999_999_998, 39_999_999_999, 40_000_000_000, 40_000_000_001, 40_000_000_002,
    49_999_999_998, 49_999_999_999, 50_000_000_000, 50_000_000_001, 50_000_000_002,
    59_999_999_998, 59_999_999_999, 60_000_000_000, 60_000_000_001, 60_000_000_002,
    69_999_999_998, 69_999_999_999, 70_000_000_000, 70_000_000_001, 70_000_000_002,
    79_999_999_998, 79_999_999_999, 80_000_000_000, 80_000_000_001, 80_000_000_002,
    89_999_999_998, 89_999_999_999, 90_000_000_000, 90_000_000_001, 90_000_000_002,
]);
